<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è°ƒè¯•å…«å­—ä¿¡æ¯è·å–é—®é¢˜</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .step {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .button {
            background: #1890ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            background: #f0f0f0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { background: #f6ffed; color: #52c41a; }
        .error { background: #fff2f0; color: #ff4d4f; }
        .warning { background: #fffbe6; color: #faad14; }
        .info { background: #e6f7ff; color: #1890ff; }
        .highlight {
            background: #fff2e8;
            padding: 10px;
            border-left: 4px solid #fa8c16;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” è°ƒè¯•å…«å­—ä¿¡æ¯è·å–é—®é¢˜</h1>
        
        <div class="highlight">
            <strong>é—®é¢˜åˆ†æ:</strong> Homeç»„ä»¶åœ¨ç¬¬89-99è¡Œæœ‰æ¡ä»¶æ¸²æŸ“é€»è¾‘ï¼šå¦‚æœç”¨æˆ·å·²ç™»å½•ä½†æ²¡æœ‰å…«å­—ä¿¡æ¯ï¼Œä¼šæ˜¾ç¤ºå¼•å¯¼å¡«å†™ä¿¡æ¯çš„é¡µé¢ï¼Œè¿™å¯èƒ½å¯¼è‡´ç™½å±ã€‚
        </div>
        
        <div class="step">
            <h3>æ­¥éª¤1: ç™»å½•å¹¶æ£€æŸ¥ç”¨æˆ·çŠ¶æ€</h3>
            <button class="button" onclick="loginAndCheckUser()">ç™»å½•å¼ ä¸‰ä¸°å¹¶æ£€æŸ¥çŠ¶æ€</button>
            <div id="userResult" class="result"></div>
        </div>
        
        <div class="step">
            <h3>æ­¥éª¤2: æ£€æŸ¥å…«å­—ä¿¡æ¯API</h3>
            <button class="button" onclick="checkBaziAPI()">æ£€æŸ¥å…«å­—ä¿¡æ¯API</button>
            <div id="baziResult" class="result"></div>
        </div>
        
        <div class="step">
            <h3>æ­¥éª¤3: æ¨¡æ‹ŸHomeç»„ä»¶é€»è¾‘</h3>
            <button class="button" onclick="simulateHomeLogic()">æ¨¡æ‹ŸHomeç»„ä»¶æ¸²æŸ“é€»è¾‘</button>
            <div id="homeLogicResult" class="result"></div>
        </div>
        
        <div class="step">
            <h3>æ­¥éª¤4: æ£€æŸ¥ç”¨æˆ·å‡ºç”Ÿä¿¡æ¯</h3>
            <button class="button" onclick="checkUserBirthInfo()">æ£€æŸ¥ç”¨æˆ·å‡ºç”Ÿä¿¡æ¯å®Œæ•´æ€§</button>
            <div id="birthInfoResult" class="result"></div>
        </div>
        
        <div class="step">
            <h3>æ­¥éª¤5: è®¿é—®Homeé¡µé¢</h3>
            <p>åœ¨å®Œæˆä¸Šè¿°æ£€æŸ¥åï¼Œè®¿é—®Homeé¡µé¢:</p>
            <a href="http://localhost:5173/home" target="_blank" class="button">ğŸ  æ‰“å¼€Homeé¡µé¢</a>
            <div class="info result">æ ¹æ®ä¸Šè¿°æ£€æŸ¥ç»“æœï¼ŒHomeé¡µé¢åº”è¯¥èƒ½æ­£å¸¸æ˜¾ç¤º</div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001';
        
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            element.className = `result ${type}`;
            element.textContent = `[${timestamp}] ${message}`;
            console.log(`[${timestamp}] ${message}`);
        }
        
        async function loginAndCheckUser() {
            try {
                log('userResult', 'æ­£åœ¨ç™»å½•å¹¶æ£€æŸ¥ç”¨æˆ·çŠ¶æ€...', 'warning');
                
                // æ¸…ç†ç¯å¢ƒ
                localStorage.clear();
                
                // ç™»å½•å¼ ä¸‰ä¸°
                const loginResponse = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        phone: '13800138000',
                        password: '123456'
                    })
                });
                
                if (!loginResponse.ok) {
                    throw new Error(`ç™»å½•å¤±è´¥: HTTP ${loginResponse.status}`);
                }
                
                const loginData = await loginResponse.json();
                console.log('ç™»å½•å“åº”:', loginData);
                
                if (!loginData.success || !loginData.data?.token || !loginData.data?.user) {
                    throw new Error('ç™»å½•å“åº”æ ¼å¼é”™è¯¯');
                }
                
                const user = loginData.data.user;
                const token = loginData.data.token;
                
                // ä¿å­˜token
                localStorage.setItem('token', token);
                
                // ä¿å­˜ç”¨æˆ·çŠ¶æ€
                const storeData = {
                    state: {
                        user: user,
                        isAuthenticated: true,
                        baziInfo: null,
                        dailyAdvice: null,
                        showWelcomeModal: false
                    },
                    version: 0
                };
                localStorage.setItem('wuxing-app-storage', JSON.stringify(storeData));
                
                // åˆ†æç”¨æˆ·ä¿¡æ¯
                let analysis = `âœ… ç™»å½•æˆåŠŸ!\n\n`;
                analysis += `ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯:\n`;
                analysis += `   - å§“å: ${user.name}\n`;
                analysis += `   - æ‰‹æœº: ${user.phone}\n`;
                analysis += `   - æ€§åˆ«: ${user.gender || 'æœªè®¾ç½®'}\n`;
                analysis += `   - å‡ºç”Ÿæ—¥æœŸ: ${user.birth_date || 'æœªè®¾ç½®'}\n`;
                analysis += `   - å‡ºç”Ÿæ—¶é—´: ${user.birth_time || 'æœªè®¾ç½®'}\n`;
                analysis += `   - å‡ºç”Ÿåœ°ç‚¹: ${user.birth_location || 'æœªè®¾ç½®'}\n\n`;
                
                // æ£€æŸ¥å‡ºç”Ÿä¿¡æ¯å®Œæ•´æ€§
                const hasBirthInfo = user.birth_date && user.birth_time;
                analysis += `ğŸ” å‡ºç”Ÿä¿¡æ¯å®Œæ•´æ€§:\n`;
                analysis += `   - å‡ºç”Ÿä¿¡æ¯å®Œæ•´: ${hasBirthInfo ? 'æ˜¯' : 'å¦'}\n`;
                
                if (!hasBirthInfo) {
                    analysis += `   âš ï¸ ç¼ºå°‘å‡ºç”Ÿä¿¡æ¯ï¼Œè¿™å¯èƒ½å¯¼è‡´Homeç»„ä»¶æ˜¾ç¤ºå¼•å¯¼é¡µé¢\n`;
                } else {
                    analysis += `   âœ… å‡ºç”Ÿä¿¡æ¯å®Œæ•´ï¼Œåº”è¯¥èƒ½è·å–å…«å­—ä¿¡æ¯\n`;
                }
                
                log('userResult', analysis, hasBirthInfo ? 'success' : 'warning');
                
            } catch (error) {
                console.error('ç™»å½•æ£€æŸ¥å¤±è´¥:', error);
                log('userResult', `âŒ ç™»å½•æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function checkBaziAPI() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    throw new Error('è¯·å…ˆç™»å½•');
                }
                
                log('baziResult', 'æ­£åœ¨æ£€æŸ¥å…«å­—ä¿¡æ¯API...', 'warning');
                
                const response = await fetch(`${API_BASE}/bazi/info`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                let result = `ğŸ”® å…«å­—ä¿¡æ¯APIæ£€æŸ¥:\n\n`;
                result += `ğŸ“¡ APIå“åº”çŠ¶æ€: ${response.status} ${response.statusText}\n\n`;
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('å…«å­—APIå“åº”:', data);
                    
                    if (data.success && data.data) {
                        const baziInfo = data.data;
                        result += `âœ… å…«å­—ä¿¡æ¯è·å–æˆåŠŸ:\n`;
                        result += `   - å¹´æŸ±: ${baziInfo.year_pillar || 'æœªçŸ¥'}\n`;
                        result += `   - æœˆæŸ±: ${baziInfo.month_pillar || 'æœªçŸ¥'}\n`;
                        result += `   - æ—¥æŸ±: ${baziInfo.day_pillar || 'æœªçŸ¥'}\n`;
                        result += `   - æ—¶æŸ±: ${baziInfo.hour_pillar || 'æœªçŸ¥'}\n`;
                        result += `   - äº”è¡Œåˆ†æ: ${JSON.stringify(baziInfo.wuxing_analysis)}\n`;
                        result += `   - ä¸»è¦äº”è¡Œ: ${baziInfo.primary_element || 'æœªçŸ¥'}\n\n`;
                        result += `ğŸ¯ ç»“è®º: æœ‰å…«å­—ä¿¡æ¯ï¼ŒHomeç»„ä»¶åº”è¯¥æ­£å¸¸æ˜¾ç¤º`;
                        
                        // æ›´æ–°localStorageä¸­çš„å…«å­—ä¿¡æ¯
                        const storeData = JSON.parse(localStorage.getItem('wuxing-app-storage') || '{}');
                        if (storeData.state) {
                            storeData.state.baziInfo = baziInfo;
                            localStorage.setItem('wuxing-app-storage', JSON.stringify(storeData));
                        }
                        
                        log('baziResult', result, 'success');
                    } else {
                        result += `âš ï¸ å…«å­—ä¿¡æ¯ä¸ºç©ºæˆ–æ ¼å¼é”™è¯¯:\n`;
                        result += `   å“åº”æ•°æ®: ${JSON.stringify(data)}\n\n`;
                        result += `ğŸ¯ ç»“è®º: æ²¡æœ‰å…«å­—ä¿¡æ¯ï¼ŒHomeç»„ä»¶ä¼šæ˜¾ç¤ºå¼•å¯¼å¡«å†™é¡µé¢`;
                        log('baziResult', result, 'warning');
                    }
                } else {
                    const errorText = await response.text();
                    result += `âŒ APIè°ƒç”¨å¤±è´¥:\n`;
                    result += `   é”™è¯¯ä¿¡æ¯: ${errorText}\n\n`;
                    result += `ğŸ¯ ç»“è®º: APIè°ƒç”¨å¤±è´¥ï¼ŒHomeç»„ä»¶ä¼šæ˜¾ç¤ºå¼•å¯¼å¡«å†™é¡µé¢`;
                    log('baziResult', result, 'error');
                }
                
            } catch (error) {
                console.error('å…«å­—APIæ£€æŸ¥å¤±è´¥:', error);
                log('baziResult', `âŒ å…«å­—APIæ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        function simulateHomeLogic() {
            try {
                const storeData = localStorage.getItem('wuxing-app-storage');
                if (!storeData) {
                    throw new Error('æ²¡æœ‰ç”¨æˆ·çŠ¶æ€æ•°æ®');
                }
                
                const parsed = JSON.parse(storeData);
                const user = parsed.state?.user;
                const baziInfo = parsed.state?.baziInfo;
                
                let simulation = `ğŸ  Homeç»„ä»¶æ¸²æŸ“é€»è¾‘æ¨¡æ‹Ÿ:\n\n`;
                
                // æ¨¡æ‹ŸHomeç»„ä»¶çš„æ¡ä»¶åˆ¤æ–­
                if (!user) {
                    simulation += `âŒ æ¡ä»¶1: !user = true\n`;
                    simulation += `   æ¸²æŸ“ç»“æœ: æ˜¾ç¤ºç™»å½•å¼•å¯¼é¡µé¢\n`;
                    simulation += `   é¡µé¢å†…å®¹: "è¯·å…ˆç™»å½•ä»¥è·å–ä¸ªæ€§åŒ–å»ºè®®"`;
                    log('homeLogicResult', simulation, 'error');
                    return;
                }
                
                simulation += `âœ… æ¡ä»¶1: !user = false (ç”¨æˆ·å·²ç™»å½•)\n`;
                simulation += `   ç”¨æˆ·: ${user.name}\n\n`;
                
                if (user && !baziInfo) {
                    simulation += `âš ï¸ æ¡ä»¶2: user && !baziInfo = true\n`;
                    simulation += `   æ¸²æŸ“ç»“æœ: æ˜¾ç¤ºå¡«å†™å‡ºç”Ÿä¿¡æ¯å¼•å¯¼é¡µé¢\n`;
                    simulation += `   é¡µé¢å†…å®¹: "æ¬¢è¿ï¼Œ${user.name}ï¼ä¸ºäº†ä¸ºæ‚¨æä¾›ç²¾å‡†çš„äº”è¡Œç©¿è¡£å»ºè®®ï¼Œè¯·å…ˆå®Œå–„æ‚¨çš„å‡ºç”Ÿä¿¡æ¯"\n`;
                    simulation += `   æŒ‰é’®: "å¡«å†™å‡ºç”Ÿä¿¡æ¯" -> è·³è½¬åˆ° /profile\n\n`;
                    simulation += `ğŸ¯ è¿™å°±æ˜¯ç™½å±çš„åŸå› ï¼ç”¨æˆ·çœ‹åˆ°çš„æ˜¯å¼•å¯¼é¡µé¢ï¼Œä¸æ˜¯ä¸»é¡µé¢å†…å®¹`;
                    log('homeLogicResult', simulation, 'warning');
                    return;
                }
                
                simulation += `âœ… æ¡ä»¶2: user && !baziInfo = false (æœ‰å…«å­—ä¿¡æ¯)\n`;
                simulation += `   å…«å­—ä¿¡æ¯: å­˜åœ¨\n`;
                simulation += `   æ¸²æŸ“ç»“æœ: æ˜¾ç¤ºå®Œæ•´çš„Homeé¡µé¢å†…å®¹\n`;
                simulation += `   é¡µé¢å†…å®¹: ç”¨æˆ·æ¬¢è¿åŒºåŸŸ + å…«å­—ä¿¡æ¯å¡ç‰‡ + ä»Šæ—¥å»ºè®®ç­‰`;
                
                log('homeLogicResult', simulation, 'success');
                
            } catch (error) {
                log('homeLogicResult', `âŒ æ¨¡æ‹Ÿå¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function checkUserBirthInfo() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    throw new Error('è¯·å…ˆç™»å½•');
                }
                
                log('birthInfoResult', 'æ­£åœ¨æ£€æŸ¥ç”¨æˆ·å‡ºç”Ÿä¿¡æ¯...', 'warning');
                
                // è·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯
                const response = await fetch(`${API_BASE}/auth/profile`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ${response.status}`);
                }
                
                const data = await response.json();
                const user = data.data?.user;
                
                if (!user) {
                    throw new Error('ç”¨æˆ·ä¿¡æ¯ä¸ºç©º');
                }
                
                let analysis = `ğŸ‘¤ ç”¨æˆ·å‡ºç”Ÿä¿¡æ¯è¯¦ç»†æ£€æŸ¥:\n\n`;
                analysis += `åŸºæœ¬ä¿¡æ¯:\n`;
                analysis += `   - å§“å: ${user.name}\n`;
                analysis += `   - æ€§åˆ«: ${user.gender || 'âŒ æœªè®¾ç½®'}\n`;
                analysis += `   - å‡ºç”Ÿæ—¥æœŸ: ${user.birth_date || 'âŒ æœªè®¾ç½®'}\n`;
                analysis += `   - å‡ºç”Ÿæ—¶é—´: ${user.birth_time || 'âŒ æœªè®¾ç½®'}\n`;
                analysis += `   - å‡ºç”Ÿåœ°ç‚¹: ${user.birth_location || 'âŒ æœªè®¾ç½®'}\n\n`;
                
                // æ£€æŸ¥å¿…è¦ä¿¡æ¯
                const requiredFields = {
                    'å‡ºç”Ÿæ—¥æœŸ': user.birth_date,
                    'å‡ºç”Ÿæ—¶é—´': user.birth_time
                };
                
                const missingFields = Object.entries(requiredFields)
                    .filter(([_, value]) => !value)
                    .map(([field, _]) => field);
                
                if (missingFields.length > 0) {
                    analysis += `âŒ ç¼ºå°‘å¿…è¦ä¿¡æ¯: ${missingFields.join(', ')}\n`;
                    analysis += `\nğŸ”§ è§£å†³æ–¹æ¡ˆ:\n`;
                    analysis += `1. è®¿é—® /profile é¡µé¢\n`;
                    analysis += `2. å¡«å†™å®Œæ•´çš„å‡ºç”Ÿä¿¡æ¯\n`;
                    analysis += `3. ä¿å­˜åé‡æ–°è®¿é—®Homeé¡µé¢\n\n`;
                    analysis += `ğŸ’¡ è¿™å°±æ˜¯ä¸ºä»€ä¹ˆHomeé¡µé¢æ˜¾ç¤ºå¼•å¯¼é¡µé¢è€Œä¸æ˜¯ä¸»è¦å†…å®¹çš„åŸå› ï¼`;
                    log('birthInfoResult', analysis, 'warning');
                } else {
                    analysis += `âœ… å‡ºç”Ÿä¿¡æ¯å®Œæ•´\n`;
                    analysis += `\nğŸ¯ ç”¨æˆ·åº”è¯¥èƒ½å¤Ÿæ­£å¸¸è·å–å…«å­—ä¿¡æ¯å¹¶çœ‹åˆ°å®Œæ•´çš„Homeé¡µé¢`;
                    log('birthInfoResult', analysis, 'success');
                }
                
            } catch (error) {
                console.error('å‡ºç”Ÿä¿¡æ¯æ£€æŸ¥å¤±è´¥:', error);
                log('birthInfoResult', `âŒ æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºè¯´æ˜
        window.onload = function() {
            console.log('ğŸ” å…«å­—ä¿¡æ¯è°ƒè¯•å·¥å…·å·²åŠ è½½');
            console.log('è¿™ä¸ªå·¥å…·å°†å¸®åŠ©è¯Šæ–­Homeé¡µé¢ç™½å±é—®é¢˜');
        };
    </script>
</body>
</html>