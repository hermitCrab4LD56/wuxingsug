<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•Homeç»„ä»¶æ¸²æŸ“</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .button {
            background: #1890ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            background: #f0f0f0;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success { background: #f6ffed; color: #52c41a; }
        .error { background: #fff2f0; color: #ff4d4f; }
        .warning { background: #fffbe6; color: #faad14; }
        .info { background: #e6f7ff; color: #1890ff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª Homeç»„ä»¶æ¸²æŸ“æµ‹è¯•</h1>
        
        <div class="test-section">
            <h3>1. å‡†å¤‡æµ‹è¯•ç¯å¢ƒ</h3>
            <button class="button" onclick="setupTestEnvironment()">è®¾ç½®æµ‹è¯•ç¯å¢ƒ</button>
            <div id="setupResult" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>2. æµ‹è¯•ç”¨æˆ·ç™»å½•</h3>
            <button class="button" onclick="testLogin()">ç™»å½•å¼ ä¸‰ä¸°</button>
            <div id="loginResult" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>3. æ£€æŸ¥Homeé¡µé¢è®¿é—®</h3>
            <button class="button" onclick="checkHomePage()">æ£€æŸ¥Homeé¡µé¢</button>
            <div id="homeCheckResult" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>4. åˆ†æé—®é¢˜</h3>
            <button class="button" onclick="analyzeIssue()">åˆ†æç™½å±é—®é¢˜</button>
            <div id="analysisResult" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>5. ç›´æ¥è®¿é—®Homeé¡µé¢</h3>
            <a href="http://localhost:5173/home" target="_blank" class="button" style="text-decoration: none; display: inline-block;">åœ¨æ–°çª—å£æ‰“å¼€Homeé¡µé¢</a>
            <div id="directAccessResult" class="result info">ç‚¹å‡»ä¸Šæ–¹é“¾æ¥åœ¨æ–°çª—å£æ‰“å¼€Homeé¡µé¢ï¼Œè§‚å¯Ÿæ˜¯å¦å‡ºç°ç™½å±</div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001';
        
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            element.className = `result ${type}`;
            element.textContent = `[${timestamp}] ${message}`;
            console.log(`[${timestamp}] ${message}`);
        }
        
        function setupTestEnvironment() {
            try {
                // æ¸…ç†ä¹‹å‰çš„æ•°æ®
                localStorage.clear();
                
                log('setupResult', 
                    'âœ… æµ‹è¯•ç¯å¢ƒå·²å‡†å¤‡å°±ç»ª\n' +
                    '- localStorageå·²æ¸…ç†\n' +
                    '- å‡†å¤‡è¿›è¡Œç™»å½•æµ‹è¯•', 
                    'success'
                );
                
            } catch (error) {
                log('setupResult', `âŒ ç¯å¢ƒå‡†å¤‡å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function testLogin() {
            try {
                log('loginResult', 'æ­£åœ¨ç™»å½•å¼ ä¸‰ä¸°...', 'warning');
                
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        phone: '13800138000',
                        password: '123456'
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('ç™»å½•å“åº”æ•°æ®:', data);
                
                if (!data.success || !data.data?.token || !data.data?.user) {
                    throw new Error('ç™»å½•å“åº”æ•°æ®æ ¼å¼é”™è¯¯: ' + JSON.stringify(data));
                }
                
                // ä¿å­˜token
                localStorage.setItem('token', data.data.token);
                
                // ä¿å­˜ç”¨æˆ·çŠ¶æ€åˆ°zustand storeæ ¼å¼
                const storeData = {
                    state: {
                        user: data.data.user,
                        isAuthenticated: true,
                        baziInfo: null
                    },
                    version: 0
                };
                localStorage.setItem('wuxing-app-storage', JSON.stringify(storeData));
                
                log('loginResult', 
                    `âœ… ç™»å½•æˆåŠŸ!\n` +
                    `ç”¨æˆ·: ${data.data.user.name}\n` +
                    `æ‰‹æœº: ${data.data.user.phone}\n` +
                    `Token: ${data.data.token.substring(0, 40)}...\n` +
                    `æ•°æ®å·²ä¿å­˜åˆ°localStorage`, 
                    'success'
                );
                
            } catch (error) {
                console.error('ç™»å½•å¤±è´¥:', error);
                log('loginResult', `âŒ ç™»å½•å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function checkHomePage() {
            try {
                const token = localStorage.getItem('token');
                const storeData = localStorage.getItem('wuxing-app-storage');
                
                if (!token) {
                    throw new Error('æœªæ‰¾åˆ°tokenï¼Œè¯·å…ˆç™»å½•');
                }
                
                if (!storeData) {
                    throw new Error('æœªæ‰¾åˆ°ç”¨æˆ·çŠ¶æ€æ•°æ®');
                }
                
                const parsedStore = JSON.parse(storeData);
                const user = parsedStore.state?.user;
                
                if (!user) {
                    throw new Error('ç”¨æˆ·çŠ¶æ€æ•°æ®ä¸­æ²¡æœ‰ç”¨æˆ·ä¿¡æ¯');
                }
                
                // æµ‹è¯•APIè°ƒç”¨
                log('homeCheckResult', 'æ­£åœ¨æµ‹è¯•APIè°ƒç”¨...', 'warning');
                
                // æµ‹è¯•profile API
                const profileResponse = await fetch(`${API_BASE}/auth/profile`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                let profileData = null;
                if (profileResponse.ok) {
                    profileData = await profileResponse.json();
                }
                
                // æµ‹è¯•bazi API
                const baziResponse = await fetch(`${API_BASE}/bazi/info`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                let baziData = null;
                if (baziResponse.ok) {
                    baziData = await baziResponse.json();
                }
                
                log('homeCheckResult', 
                    `âœ… Homeé¡µé¢æ•°æ®æ£€æŸ¥å®Œæˆ:\n` +
                    `Token: å­˜åœ¨ (${token.substring(0, 30)}...)\n` +
                    `ç”¨æˆ·: ${user.name} (${user.phone})\n` +
                    `Profile API: ${profileResponse.ok ? 'æ­£å¸¸' : 'å¤±è´¥ ' + profileResponse.status}\n` +
                    `å…«å­— API: ${baziResponse.ok ? 'æ­£å¸¸' : 'å¤±è´¥ ' + baziResponse.status}\n` +
                    `ç°åœ¨å¯ä»¥è®¿é—®Homeé¡µé¢`, 
                    'success'
                );
                
            } catch (error) {
                console.error('Homeé¡µé¢æ£€æŸ¥å¤±è´¥:', error);
                log('homeCheckResult', `âŒ æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        function analyzeIssue() {
            try {
                const token = localStorage.getItem('token');
                const storeData = localStorage.getItem('wuxing-app-storage');
                
                let analysis = 'ğŸ” ç™½å±é—®é¢˜åˆ†æ:\n\n';
                
                // æ£€æŸ¥è®¤è¯çŠ¶æ€
                if (!token) {
                    analysis += 'âŒ é—®é¢˜1: ç¼ºå°‘è®¤è¯token\n';
                    analysis += '   è§£å†³æ–¹æ¡ˆ: ç¡®ä¿ç”¨æˆ·å·²ç™»å½•\n\n';
                } else {
                    analysis += 'âœ… è®¤è¯token: å­˜åœ¨\n\n';
                }
                
                // æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
                if (!storeData) {
                    analysis += 'âŒ é—®é¢˜2: ç¼ºå°‘ç”¨æˆ·çŠ¶æ€æ•°æ®\n';
                    analysis += '   è§£å†³æ–¹æ¡ˆ: ç¡®ä¿zustand storeæ•°æ®æ­£ç¡®ä¿å­˜\n\n';
                } else {
                    try {
                        const parsed = JSON.parse(storeData);
                        const user = parsed.state?.user;
                        if (!user) {
                            analysis += 'âŒ é—®é¢˜3: ç”¨æˆ·çŠ¶æ€æ•°æ®æ ¼å¼é”™è¯¯\n';
                            analysis += '   è§£å†³æ–¹æ¡ˆ: æ£€æŸ¥storeæ•°æ®ç»“æ„\n\n';
                        } else {
                            analysis += 'âœ… ç”¨æˆ·çŠ¶æ€: æ­£å¸¸\n\n';
                        }
                    } catch (e) {
                        analysis += 'âŒ é—®é¢˜4: ç”¨æˆ·çŠ¶æ€æ•°æ®è§£æå¤±è´¥\n';
                        analysis += '   è§£å†³æ–¹æ¡ˆ: æ£€æŸ¥JSONæ ¼å¼\n\n';
                    }
                }
                
                // å¯èƒ½çš„åŸå› 
                analysis += 'ğŸ¤” å¯èƒ½çš„ç™½å±åŸå› :\n';
                analysis += '1. Reactç»„ä»¶æ¸²æŸ“é”™è¯¯\n';
                analysis += '2. CSSæ ·å¼é—®é¢˜å¯¼è‡´å†…å®¹ä¸å¯è§\n';
                analysis += '3. JavaScripté”™è¯¯é˜»æ­¢æ¸²æŸ“\n';
                analysis += '4. è·¯ç”±ä¿æŠ¤é€»è¾‘é—®é¢˜\n';
                analysis += '5. APIè°ƒç”¨å¤±è´¥å¯¼è‡´ç»„ä»¶å¡ä½\n\n';
                
                analysis += 'ğŸ”§ å»ºè®®çš„è°ƒè¯•æ­¥éª¤:\n';
                analysis += '1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·\n';
                analysis += '2. æŸ¥çœ‹Consoleæ ‡ç­¾é¡µçš„é”™è¯¯ä¿¡æ¯\n';
                analysis += '3. æŸ¥çœ‹Networkæ ‡ç­¾é¡µçš„APIè¯·æ±‚\n';
                analysis += '4. æŸ¥çœ‹Elementsæ ‡ç­¾é¡µçš„DOMç»“æ„\n';
                analysis += '5. æ£€æŸ¥React DevTools (å¦‚æœå·²å®‰è£…)';
                
                log('analysisResult', analysis, 'info');
                
            } catch (error) {
                log('analysisResult', `âŒ åˆ†æå¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.onload = function() {
            console.log('ğŸ§ª Homeç»„ä»¶æ¸²æŸ“æµ‹è¯•å·¥å…·å·²åŠ è½½');
            
            // æ˜¾ç¤ºå½“å‰çŠ¶æ€
            const token = localStorage.getItem('token');
            const storeData = localStorage.getItem('wuxing-app-storage');
            
            console.log('å½“å‰çŠ¶æ€:', {
                hasToken: !!token,
                hasStoreData: !!storeData,
                token: token ? token.substring(0, 30) + '...' : null
            });
        };
    </script>
</body>
</html>